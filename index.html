<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTVC Portal</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f0f2f5;}
#loginBox,#portal{padding:20px;}
input,select,textarea,button{display:block;margin:10px 0;padding:8px;width:100%;max-width:400px;}
#sidebar{width:200px;float:left;background:#1976d2;color:white;padding:10px;min-height:90vh;}
#content{margin-left:220px;padding:20px;}
table{border-collapse:collapse;width:100%;max-width:800px;}
table,th,td{border:1px solid #ccc;}
th,td{padding:8px;text-align:left;}
.card{background:white;padding:15px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h3>MTVC Secure Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <select id="role">
    <option value="">Select Role</option>
    <option value="student">Student</option>
    <option value="staff">Staff</option>
    <option value="finance">Finance</option>
    <option value="admin">Admin</option>
  </select>
  <button type="button" id="loginBtn">Login</button>
  <button type="button" id="signupBtn">Create Account</button>
  <p id="loginMsg"></p>
</div>

<!-- PORTAL -->
<div id="portal" style="display:none">
<header>
  <div style="display:flex;align-items:center;">
    <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    <img src="logo.png" alt="MTVC Logo" style="height:40px;margin-left:10px;">
    <h3 style="margin-left:10px;">MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE</h3>
  </div>
</header>

<div id="sidebar">
  <a onclick="menuClick('dashboard')">Dashboard</a>
  <a onclick="menuClick('student')">Student Registration</a>
  <a onclick="menuClick('staff')">Staff Registration</a>
  <a onclick="menuClick('finance')">Finance</a>
  <a onclick="menuClick('academics')">Academic Results</a>
  <a onclick="menuClick('contact')">Contact Form</a>
  <a onclick="logout()">Logout</a>
</div>

<div id="content">
  <!-- Dashboard -->
  <div class="card" id="dashboard">
    <h3>Dashboard</h3>
    <div>Total Students: <span id="totalStudents">0</span></div>
    <div>Total Staff: <span id="totalStaff">0</span></div>
    <div>Total Fees Paid: <span id="totalFees">0</span></div>
    <div>Total Balance: <span id="totalBalance">0</span></div>
  </div>

  <!-- Student Registration -->
  <form class="card" id="student" style="display:none;" onsubmit="return false;">
    <h3>Student Registration</h3>
    <input id="stuName" placeholder="Name">
    <input id="stuReg" placeholder="Reg No">
    <input id="stuEmail" placeholder="Email">
    <input id="stuTerm" placeholder="Term (1,2,3)">
    <input id="stuYear" placeholder="Year">
    <input id="stuCourse" placeholder="Course">
    <button type="button" id="saveStudentBtn">Save & Download PDF</button>
    <p class="msg" id="stuMsg"></p>
  </form>

  <!-- Staff Registration -->
  <form class="card" id="staff" style="display:none;" onsubmit="return false;">
    <h3>Staff Registration</h3>
    <input id="sName" placeholder="Name">
    <input id="sRole" placeholder="Role">
    <input id="sEmail" placeholder="Email">
    <input id="sPhone" placeholder="Phone">
    <input id="sDept" placeholder="Department">
    <button type="button" id="saveStaffBtn">Save & Download PDF</button>
    <p class="msg" id="sMsg"></p>
  </form>

  <!-- Finance -->
  <form class="card" id="finance" style="display:none;" onsubmit="return false;">
    <h3>Finance</h3>
    <input id="fReg" placeholder="Reg No">
    <input id="fName" placeholder="Name">
    <input id="fPaid" type="number" placeholder="Amount Paid">
    <input id="fTerm" placeholder="Term">
    <input id="fYear" placeholder="Year">
    <button type="button" id="saveFinanceBtn">Save & Download Fee PDF</button>
    <p class="msg" id="fMsg"></p>
  </form>

  <!-- Academic Results -->
  <form class="card" id="academics" style="display:none;" onsubmit="return false;">
    <h3>Academic Results</h3>
    <input id="aReg" placeholder="Reg No">
    <input id="aName" placeholder="Name">
    <input id="aUnit" placeholder="Unit">
    <input id="aScore" type="number" placeholder="Score">
    <input id="aTerm" placeholder="Term">
    <input id="aYear" placeholder="Year">
    <button type="button" id="saveResultBtn">Save & Download PDF</button>
    <p class="msg" id="aMsg"></p>
  </form>

  <!-- Contact Form -->
  <div class="card" id="contact" style="display:none;">
    <h3>Contact Form</h3>
    <form id="contact-form">
      <input type="text" name="name" placeholder="Name" required />
      <input type="email" name="email" placeholder="Email" required />
      <textarea name="message" placeholder="Message" required></textarea>
      <button type="submit">Send</button>
    </form>
    <h4>Submissions</h4>
    <table id="contactTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Message</th><th>Timestamp</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</div>

<!-- Supabase first -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Main JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Supabase setup
  const SUPABASE_URL = "https://lsntdhhtvgyzqxhnedjp.supabase.co";
  const SUPABASE_KEY = "sb_publishable_823RtCxy7OHVfPHskoydeQ_O21XMVKO";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===== LOGIN / SIGNUP =====
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const loginMsg = document.getElementById('loginMsg');

  loginBtn.addEventListener('click', async ()=>{
    const emailVal = email.value.trim();
    const passwordVal = password.value.trim();
    loginMsg.style.color="blue"; loginMsg.innerText="Logging in...";
    try{
      const { data:user, error } = await supabase.auth.signInWithPassword({email:emailVal,password:passwordVal});
      if(error) throw error;
      loginBox.style.display="none"; portal.style.display="block";
      loginMsg.style.color="green"; loginMsg.innerText="ðŸŽ‰ Logged in!";
      loadDashboard(); loadContacts();
    }catch(e){loginMsg.style.color="red"; loginMsg.innerText=e.message;}
  });

  signupBtn.addEventListener('click', async ()=>{
    const emailVal = email.value.trim();
    const passwordVal = password.value.trim();
    const roleVal = role.value;
    if(!emailVal||!passwordVal||!roleVal){loginMsg.style.color="red";loginMsg.innerText="Fill all fields";return;}
    loginMsg.style.color="blue"; loginMsg.innerText="Creating account...";
    try{
      const { data: existing } = await supabase.from('users').select('*').eq('email', emailVal);
      if(existing.length>0){loginMsg.style.color="red";loginMsg.innerText="Account exists";return;}
      const { data: user, error: signErr } = await supabase.auth.signUp({email:emailVal,password:passwordVal});
      if(signErr) throw signErr;
      const { error: dbErr } = await supabase.from('users').insert([{id:user.user.id,email:emailVal,role:roleVal}]);
      if(dbErr) throw dbErr;
      loginMsg.style.color="green"; loginMsg.innerText="âœ… Account created!";
    }catch(e){loginMsg.style.color="red"; loginMsg.innerText=e.message;}
  });

  function toggleSidebar(){document.getElementById("sidebar").classList.toggle("collapsed");}
  function menuClick(id){document.querySelectorAll("#content > .card").forEach(d=>d.style.display="none"); document.getElementById(id).style.display="block";}
  async function logout(){await supabase.auth.signOut();location.reload();}

  // ===== DASHBOARD =====
  async function loadDashboard(){
    const { data: students } = await supabase.from('students').select('*');
    const { data: staff } = await supabase.from('staff').select('*');
    const { data: finance } = await supabase.from('finance').select('*');
    document.getElementById("totalStudents").innerText=students.length;
    document.getElementById("totalStaff").innerText=staff.length;
    let totalPaid=0,totalBalance=0;
    finance.forEach(f=>{totalPaid+=f.paid||0; totalBalance+=((40000-f.paid)||0);});
    document.getElementById("totalFees").innerText=totalPaid;
    document.getElementById("totalBalance").innerText=totalBalance;
  }

  // ===== STUDENT =====
  document.getElementById('saveStudentBtn').addEventListener('click', async ()=>{
    const name=stuName.value, reg=stuReg.value, emailVal=stuEmail.value, term=stuTerm.value, year=stuYear.value, course=stuCourse.value;
    if(!name||!reg||!emailVal||!term||!year||!course){stuMsg.innerText="Fill all fields";return;}
    const timestamp=new Date().toLocaleString();
    await supabase.from('students').upsert([{reg,name,email:emailVal,term,year,course,timestamp}]);
    stuMsg.innerText="Saved âœ…"; downloadStudentPDF({name,reg,email:emailVal,term,year,course,timestamp});
    loadDashboard();
  });

  // ===== STAFF =====
  document.getElementById('saveStaffBtn').addEventListener('click', async ()=>{
    const nameVal=sName.value, roleVal=sRole.value, emailVal=sEmail.value, phoneVal=sPhone.value, deptVal=sDept.value;
    if(!nameVal||!roleVal||!emailVal||!phoneVal||!deptVal){sMsg.innerText="Fill all fields";return;}
    const timestamp=new Date().toLocaleString();
    await supabase.from('staff').upsert([{name:nameVal,role:roleVal,email:emailVal,phone:phoneVal,dept:deptVal,timestamp}]);
    sMsg.innerText="Saved âœ…"; downloadStaffPDF({name:nameVal,role:roleVal,email:emailVal,phone:phoneVal,dept:deptVal,timestamp});
    loadDashboard();
  });

  // ===== FINANCE =====
  document.getElementById('saveFinanceBtn').addEventListener('click', async ()=>{
    const reg=fReg.value,nameVal=fName.value,paid=parseFloat(fPaid.value)||0,term=fTerm.value,year=fYear.value;
    if(!reg||!nameVal||!term||!year){fMsg.innerText="Fill all fields";return;}
    const balance=40000-paid, timestamp=new Date().toLocaleString();
    await supabase.from('finance').upsert([{reg,name:nameVal,paid,balance,term,year,timestamp}]);
    fMsg.innerText="Saved âœ…"; loadDashboard();
  });

  // ===== ACADEMICS =====
  document.getElementById('saveResultBtn').addEventListener('click', async ()=>{
    const reg=aReg.value,nameVal=aName.value,unit=aUnit.value,score=parseFloat(aScore.value)||0,term=aTerm.value,year=aYear.value;
    if(!reg||!nameVal||!unit||!score||!term||!year){aMsg.innerText="Fill all fields";return;}
    const grade=(score>=80?"Mastery":score>=70?"Proficient":score>=60?"Competent":"Not Competent");
    const timestamp=new Date().toLocaleString();
    await supabase.from('academics').upsert([{reg,name:nameVal,unit,score,grade,term,year,timestamp}]);
    aMsg.innerText="Saved âœ…";
  });

  // ===== CONTACT FORM =====
  const contactForm=document.getElementById('contact-form');
  contactForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const name=contactForm.name.value.trim(), emailVal=contactForm.email.value.trim(), message=contactForm.message.value.trim();
    if(!name||!emailVal||!message) return alert("Fill all fields");
    const timestamp=new Date().toLocaleString();
    await supabase.from('contacts').insert([{name,email:emailVal,message,timestamp}]);
    contactForm.reset(); loadContacts();
  });

  async function loadContacts(){
    const { data: contacts } = await supabase.from('contacts').select('*').order('timestamp',{ascending:false});
    const tbody=document.querySelector('#contactTable tbody'); tbody.innerHTML='';
    contacts.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.name}</td><td>${c.email}</td><td>${c.message}</td><td>${c.timestamp}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== PDF Downloads =====
  function downloadStudentPDF(d){const doc=new jspdf.jsPDF();doc.setFontSize(14);doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",10,10);doc.text(`Name: ${d.name}`,10,20);doc.text(`Reg: ${d.reg}`,10,30);doc.text(`Email: ${d.email}`,10,40);doc.text(`Course: ${d.course}`,10,50);doc.text(`Term: ${d.term}`,10,60);doc.text(`Year: ${d.year}`,10,70);doc.text(`Timestamp: ${d.timestamp}`,10,80);doc.save(`Student_${d.reg}.pdf`);}
  function downloadStaffPDF(d){const doc=new jspdf.jsPDF();doc.setFontSize(14);doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",10,10);doc.text(`Name: ${d.name}`,10,20);doc.text(`Role: ${d.role}`,10,30);doc.text(`Email: ${d.email}`,10,40);doc.text(`Phone: ${d.phone}`,10,50);doc.text(`Dept: ${d.dept}`,10,60);doc.text(`Timestamp: ${d.timestamp}`,10,70);doc.save(`Staff_${d.email}.pdf`);}
  function downloadFinancePDF(d){const doc=new jspdf.jsPDF();doc.setFontSize(14);doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",10,10);doc.text(`Name: ${d.name}`,10,20);doc.text(`Reg: ${d.reg}`,10,30);doc.text(`Term: ${d.term}`,10,40);doc.text(`Year: ${d.year}`,10,50);doc.text(`Paid: Ksh ${d.paid}`,10,60);doc.text(`Balance: Ksh ${d.balance}`,10,70);doc.text(`Timestamp: ${d.timestamp}`,10,80);doc.save(`Fee_${d.reg}_${d.term}_${d.year}.pdf`);}
  function downloadResultPDF(d){const doc=new jspdf.jsPDF();doc.setFontSize(14);doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",10,10);doc.text(`Name: ${d.name}`,10,20);doc.text(`Reg: ${d.reg}`,10,30);doc.text(`Unit: ${d.unit}`,10,40);doc.text(`Score: ${d.score}`,10,50);doc.text(`Grade: ${d.grade}`,10,60);doc.text(`Term: ${d.term}`,10,70);doc.text(`Year: ${d.year}`,10,80);doc.text(`Timestamp: ${d.timestamp}`,10,90);doc.save(`Result_${d.reg}_${d.unit}.pdf`);}
});
</script>
</body>
</html>
