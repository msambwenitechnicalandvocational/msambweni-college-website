<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Msambweni TVC Portals</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF & AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
:root{
  --blue:#0d47a1;
  --light:#1976d2;
  --green:#2e7d32;
  --red:#c62828;
  --yellow:#fbc02d;
}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fb;}
header{
  background:linear-gradient(90deg,var(--blue),var(--light));
  color:white;
  padding:15px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
}
header img{height:60px;margin:5px;}
header h1{margin:0;font-size:18px;text-align:center;flex:1;}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{background:white;border-radius:14px;padding:25px;box-shadow:0 15px 35px rgba(0,0,0,.15);margin-bottom:30px;}
h2,h3,h4{text-align:center;color:var(--blue);}
input,select{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;}
button{padding:10px 18px;border:none;border-radius:6px;color:white;cursor:pointer;margin-top:8px;}
button.login{background:var(--light);}
button.create{background:var(--green);}
button.download{background:var(--green);}
button.logout{background:var(--red);}
.link{text-align:center;color:var(--light);cursor:pointer;margin-top:8px;font-size:14px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:10px;text-align:center;}
th{background:var(--light);color:white;}
tbody tr:nth-child(even){background:#f0f4f8;}
tbody tr:hover{background:#dbe9fc;}
footer{background:var(--blue);color:white;padding:20px;text-align:center;margin-top:40px;}
.unit{border:1px solid #ccc;padding:10px;border-radius:10px;margin-bottom:10px;background:#f9f9f9;}

/* RESPONSIVE */
@media(max-width:768px){
  header{flex-direction:column;text-align:center;}
  header h1{margin:10px 0;}
  .card{padding:15px;}
  input, select, button{font-size:14px;}
  table th, table td{padding:6px;font-size:12px;}
  button{padding:8px 12px;}
}
</style>
</head>
<body>

<header>
<img src="images/logo-left.png">
<h1>MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE</h1>
<img src="images/logo-right.png">
</header>

<div class="container">

<!-- PORTAL SELECTION -->
<div class="card" id="portalSelect">
  <h2>Select Portal</h2>
  <button class="login" onclick="openAuth('ict')">ICT Portal</button>
  <button class="login" onclick="openAuth('library')">Library Portal</button>
  <button class="login" onclick="openAuth('finance')">Finance Portal</button>
  <button class="login" onclick="openAuth('exam')">Exam Portal</button>
</div>

<!-- ===== AUTH MODALS ===== -->
<div class="card hidden" id="auth">
  <h3 id="authTitle"></h3>
  <input id="aUser" placeholder="Username">
  <input id="aPass" type="password" placeholder="Password">
  <button class="login" onclick="login()">Login</button>
  <div class="link" onclick="showCreate()">Create Account</div>
  <div class="link" onclick="showForgot()">Forgot Password?</div>
  <p id="authMsg" style="color:red;"></p>
</div>

<div class="card hidden" id="create">
  <h3>Create Account</h3>
  <input id="cUser" placeholder="Username">
  <input id="cPass" type="password" placeholder="Password">
  <button class="create" onclick="createAccount()">Create Account</button>
  <div class="link" onclick="backAuth()">Back to Login</div>
</div>

<div class="card hidden" id="forgot">
  <h3>Recover Password</h3>
  <input id="fUser" placeholder="Username">
  <button class="login" onclick="recover()">Recover</button>
  <div class="link" onclick="backAuth()">Back to Login</div>
  <p id="fMsg" style="color:red;"></p>
</div>

<!-- ===== ICT PORTAL ===== -->
<div class="card hidden" id="ict">
  <h3>ICT Support Portal</h3>
  <div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px;">
    <select id="ictFilter" onchange="filterICTTickets()">
      <option value="all">All Statuses</option>
      <option value="Pending">Pending</option>
      <option value="Resolved">Resolved</option>
    </select>
    <input id="ictSearch" placeholder="Search by Device, Issue, or Name" onkeyup="filterICTTickets()" style="flex:1;">
  </div>
  <table id="ictTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Issue</th>
        <th>Device</th>
        <th>Start Date</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <input id="ictName" placeholder="Your Name">
  <input id="ictIssue" placeholder="Issue Description">
  <input type="date" id="ictStartDate">
  <input id="ictDevice" placeholder="Device / Serial Number">
  <select id="ictStatus"><option>Pending</option><option>Resolved</option></select>
  <select id="ictPriority"><option>Low</option><option>Medium</option><option>High</option></select>
  <button class="download" onclick="saveICTTicket()">Submit Ticket</button>
  <button class="download" onclick="downloadICTPDF()">Download All Tickets PDF</button>
  <button class="logout" onclick="logoutPortal()">Logout</button>
</div>

<!-- ===== LIBRARY PORTAL ===== -->
<div class="card hidden" id="library">
  <h3>Library Portal</h3>
  <input id="libUser" placeholder="Username">
  <input id="libPass" type="password" placeholder="Password">
  <button class="login" onclick="libraryLogin()">Login</button>
  <div class="link" onclick="showLibraryCreate()">Create Account</div>
  <div class="link" onclick="showLibraryForgot()">Forgot Password?</div>
  <p id="libAuthMsg"></p>

  <div id="libraryForm" class="hidden">
    <input id="libStudentName" placeholder="Student Name">
    <input id="libCourse" placeholder="Course">
    <input id="libRegNo" placeholder="Registration Number">
    <table id="libTable">
      <thead><tr><th>Book</th><th>Author</th><th>Action</th><th>Date</th></tr></thead>
      <tbody></tbody>
    </table>
    <input id="libTitle" placeholder="Book Title">
    <input id="libAuthor" placeholder="Author">
    <select id="libAction"><option>Borrow</option><option>Return</option></select>
    <input type="file" id="libFile" accept="application/pdf">
    <label><input type="checkbox" id="libAttendance"> Mark Present</label>
    <button class="download" onclick="saveLibraryEntry()">Save Entry</button>
    <button class="download" onclick="downloadLibraryPDF()">Download PDF</button>
    <button class="logout" onclick="logoutPortal()">Logout</button>
  </div>
</div>

<!-- ===== FINANCE PORTAL ===== -->
<div class="card hidden" id="finance">
  <h3>Finance Portal</h3>
  <table id="fHistory"><thead><tr><th>Date</th><th>Receipt</th><th>Amount</th></tr></thead><tbody></tbody></table>
  <input id="fName" placeholder="Student Name">
  <input id="fReg" placeholder="Registration Number">
  <input id="fTotal" placeholder="Total Fees" value="50000">
  <input id="fPaid" placeholder="Amount Paid" value="20000">
  <p>Balance: <span id="fBalance">30000</span></p>
  <button class="download" onclick="calcBalance()">Calculate Balance</button>
  <button class="download" onclick="saveFinanceData()">Save Payment</button>
  <button class="download" onclick="downloadFeePDF()">Download Fee Statement PDF</button>
  <button class="logout" onclick="logoutPortal()">Logout</button>
</div>

<!-- ===== EXAM PORTAL ===== -->
<div class="card hidden" id="exam">
  <h3>Exam Portal</h3>
  <div id="examAuth">
    <input id="examUser" placeholder="Username">
    <input id="examPass" type="password" placeholder="Password">
    <button class="login" onclick="examLogin()">Login</button>
    <div class="link" onclick="showExamCreate()">Create Account</div>
    <div class="link" onclick="showExamForgot()">Forgot Password?</div>
    <p id="examMsg" style="color:red"></p>
  </div>

  <div id="examForm" class="hidden">
    <input id="examFullName" placeholder="Full Name">
    <input id="examRegNo" placeholder="Registration Number">
    <input id="examCourse" placeholder="Course Name">
    <h4>Enter Marks for 4 Units</h4>
    <div class="unit">
      <input type="text" placeholder="Unit 1 Name" id="unit1Name">
      <input type="number" placeholder="CAT 1 (0-30)" id="unit1Cat1">
      <input type="number" placeholder="CAT 2 (0-30)" id="unit1Cat2">
      <input type="number" placeholder="Exam Marks (0-40)" id="unit1Exam">
    </div>
    <div class="unit">
      <input type="text" placeholder="Unit 2 Name" id="unit2Name">
      <input type="number" placeholder="CAT 1 (0-30)" id="unit2Cat1">
      <input type="number" placeholder="CAT 2 (0-30)" id="unit2Cat2">
      <input type="number" placeholder="Exam Marks (0-40)" id="unit2Exam">
    </div>
    <div class="unit">
      <input type="text" placeholder="Unit 3 Name" id="unit3Name">
      <input type="number" placeholder="CAT 1 (0-30)" id="unit3Cat1">
      <input type="number" placeholder="CAT 2 (0-30)" id="unit3Cat2">
      <input type="number" placeholder="Exam Marks (0-40)" id="unit3Exam">
    </div>
    <div class="unit">
      <input type="text" placeholder="Unit 4 Name" id="unit4Name">
      <input type="number" placeholder="CAT 1 (0-30)" id="unit4Cat1">
      <input type="number" placeholder="CAT 2 (0-30)" id="unit4Cat2">
      <input type="number" placeholder="Exam Marks (0-40)" id="unit4Exam">
    </div>
    <button class="calculateBtn" onclick="calculateAllGrades()">Calculate Grades</button>
    <table id="examTable">
      <thead><tr><th>Unit</th><th>CAT 1</th><th>CAT 2</th><th>Exam</th><th>Total</th><th>Grade</th></tr></thead>
      <tbody>
        <tr><td id="resUnit1">-</td><td id="resCat11">-</td><td id="resCat12">-</td><td id="resExam1">-</td><td id="resTotal1">-</td><td id="resGrade1">-</td></tr>
        <tr><td id="resUnit2">-</td><td id="resCat21">-</td><td id="resCat22">-</td><td id="resExam2">-</td><td id="resTotal2">-</td><td id="resGrade2">-</td></tr>
        <tr><td id="resUnit3">-</td><td id="resCat31">-</td><td id="resCat32">-</td><td id="resExam3">-</td><td id="resTotal3">-</td><td id="resGrade3">-</td></tr>
        <tr><td id="resUnit4">-</td><td id="resCat41">-</td><td id="resCat42">-</td><td id="resExam4">-</td><td id="resTotal4">-</td><td id="resGrade4">-</td></tr>
      </tbody>
    </table>
    <button class="download" onclick="downloadExamPDF()">Download PDF</button>
    <button class="logout" onclick="logoutPortal()">Logout</button>
  </div>
</div>

<footer>
  <p>Prepared by ICT Department | All Rights Reserved Â© 2026</p>
</footer>

<script>
const { jsPDF } = window.jspdf;

// ====== PORTAL MANAGEMENT ======
let currentPortal = '';
function openAuth(p){
  currentPortal=p;
  portalSelect.classList.add('hidden');
  auth.classList.remove('hidden');
  authTitle.innerText=p.toUpperCase()+' PORTAL LOGIN';
  aUser.value=''; aPass.value=''; authMsg.innerText='';
}
function logoutPortal(){
  document.querySelectorAll('#ict,#library,#finance,#exam').forEach(e=>e.classList.add('hidden'));
  portalSelect.classList.remove('hidden');
}

// ====== USERS & STORAGE ======
let users = JSON.parse(localStorage.getItem('portalUsers')||'{}');
if(!users['ict']) users['ict']=[];
if(!users['library']) users['library']=[];
if(!users['finance']) users['finance']=[];
if(!users['exam']) users['exam']=[];
localStorage.setItem('portalUsers',JSON.stringify(users));

// ====== AUTH FUNCTIONS ======
function login(){
  const portalUsers=JSON.parse(localStorage.getItem('portalUsers'));
  const u=currentPortal;
  const user=aUser.value, pass=aPass.value;
  if(portalUsers[u].find(x=>x.user===user && x.pass===pass)){
    auth.classList.add('hidden');
    if(u==='ict'){document.getElementById('ict').classList.remove('hidden'); loadICTTickets();}
    if(u==='library'){document.getElementById('libraryForm').classList.remove('hidden'); document.getElementById('library').classList.remove('hidden'); loadLibraryTable();}
    if(u==='finance'){document.getElementById('finance').classList.remove('hidden'); loadFinanceTable();}
    if(u==='exam'){document.getElementById('examForm').classList.remove('hidden'); document.getElementById('exam').classList.remove('hidden');}
  } else {authMsg.innerText='Invalid login'}
}
function showCreate(){auth.classList.add('hidden'); create.classList.remove('hidden');}
function showForgot(){auth.classList.add('hidden'); forgot.classList.remove('hidden');}
function backAuth(){create.classList.add('hidden'); forgot.classList.add('hidden'); auth.classList.remove('hidden');}
function createAccount(){
  const portalUsers=JSON.parse(localStorage.getItem('portalUsers'));
  portalUsers[currentPortal].push({user:cUser.value,pass:cPass.value});
  localStorage.setItem('portalUsers',JSON.stringify(portalUsers));
  alert('Account created!');
  backAuth();
}
function recover(){
  const portalUsers=JSON.parse(localStorage.getItem('portalUsers'));
  const u=portalUsers[currentPortal].find(x=>x.user===fUser.value);
  fMsg.innerText = u ? "Password: "+u.pass : "User not found";
}

// ====== ICT PORTAL ======
if(!localStorage.getItem('ictTickets')) localStorage.setItem('ictTickets',JSON.stringify([]));
function saveICTTicket(){
  const tickets=JSON.parse(localStorage.getItem('ictTickets'));
  const ticket={
    id:tickets.length+1,
    name:ictName.value, issue:ictIssue.value, device:ictDevice.value,
    status:ictStatus.value, priority:ictPriority.value, startDate:ictStartDate.value,
    submittedDate:new Date().toLocaleString()
  };
  if(!ticket.name||!ticket.issue||!ticket.device||!ticket.startDate){alert("Fill all fields"); return;}
  tickets.push(ticket);
  localStorage.setItem('ictTickets',JSON.stringify(tickets));
  ictName.value=''; ictIssue.value=''; ictDevice.value=''; ictStartDate.value='';
  ictStatus.value='Pending'; ictPriority.value='Low';
  loadICTTickets();
}
function loadICTTickets(){
  const tickets=JSON.parse(localStorage.getItem('ictTickets'));
  const tbody=document.querySelector('#ictTable tbody'); tbody.innerHTML='';
  tickets.forEach(t=>{
    tbody.innerHTML+=`<tr>
      <td>${t.id}</td><td>${t.name}</td><td>${t.issue}</td><td>${t.device}</td><td>${t.startDate}</td><td>${t.status}</td><td>${t.priority}</td>
      <td><button onclick="resolveICT(${t.id})">Resolve</button></td>
    </tr>`;
  });
}
function resolveICT(id){
  const tickets=JSON.parse(localStorage.getItem('ictTickets'));
  const t=tickets.find(x=>x.id===id); t.status='Resolved';
  localStorage.setItem('ictTickets',JSON.stringify(tickets));
  loadICTTickets();
}
function downloadICTPDF(){
  const tickets=JSON.parse(localStorage.getItem('ictTickets'));
  const doc=new jsPDF();
  doc.text("ICT Support Tickets",14,20);
  doc.autoTable({head:[['ID','Name','Issue','Device','Start Date','Status','Priority']], body:tickets.map(t=>[t.id,t.name,t.issue,t.device,t.startDate,t.status,t.priority])});
  doc.save('ICT_Tickets.pdf');
}

// ====== LIBRARY PORTAL ======
if(!localStorage.getItem('libEntries')) localStorage.setItem('libEntries',JSON.stringify([]));
function saveLibraryEntry(){
  const entries=JSON.parse(localStorage.getItem('libEntries'));
  const e={student:libStudentName.value,course:libCourse.value,reg:libRegNo.value,
    book:libTitle.value,author:libAuthor.value,action:libAction.value,date:new Date().toLocaleString(),
    attendance:libAttendance.checked};
  if(!e.student||!e.book){alert("Fill student & book"); return;}
  entries.push(e); localStorage.setItem('libEntries',JSON.stringify(entries));
  loadLibraryTable();
  libTitle.value=''; libAuthor.value=''; libAction.value='Borrow'; libAttendance.checked=false;
}
function loadLibraryTable(){
  const entries=JSON.parse(localStorage.getItem('libEntries'));
  const tbody=document.querySelector('#libTable tbody'); tbody.innerHTML='';
  entries.forEach((e,i)=>{tbody.innerHTML+=`<tr>
    <td>${e.book}</td><td>${e.author}</td><td>${e.action}</td><td>${e.date}</td></tr>`});
}
function downloadLibraryPDF(){
  const entries=JSON.parse(localStorage.getItem('libEntries'));
  const doc=new jsPDF();
  doc.text("Library Records",14,20);
  doc.autoTable({head:[['Book','Author','Action','Date']],body:entries.map(e=>[e.book,e.author,e.action,e.date])});
  doc.save('Library_Records.pdf');
}

// ====== FINANCE PORTAL ======
if(!localStorage.getItem('financeRecords')) localStorage.setItem('financeRecords',JSON.stringify([]));
function calcBalance(){
  const bal=Number(fTotal.value)-Number(fPaid.value);
  fBalance.innerText=bal;
}
function saveFinanceData(){
  const rec=JSON.parse(localStorage.getItem('financeRecords'));
  rec.push({date:new Date().toLocaleDateString(),receipt:'R-'+(rec.length+1),amount:fPaid.value});
  localStorage.setItem('financeRecords',JSON.stringify(rec));
  loadFinanceTable();
}
function loadFinanceTable(){
  const rec=JSON.parse(localStorage.getItem('financeRecords'));
  const tbody=document.querySelector('#fHistory tbody'); tbody.innerHTML='';
  rec.forEach(r=>{tbody.innerHTML+=`<tr><td>${r.date}</td><td>${r.receipt}</td><td>${r.amount}</td></tr>`});
}
function downloadFeePDF(){
  const rec=JSON.parse(localStorage.getItem('financeRecords'));
  const doc=new jsPDF(); doc.text("Fee Statement",14,20);
  doc.autoTable({head:[['Date','Receipt','Amount']],body:rec.map(r=>[r.date,r.receipt,r.amount])});
  doc.save('Fee_Statement.pdf');
}

// ====== EXAM PORTAL ======
if(!localStorage.getItem('examUsers')) localStorage.setItem('examUsers',JSON.stringify([]));
function examLogin(){
  const eu=JSON.parse(localStorage.getItem('examUsers'));
  const u=eu.find(x=>x.user===examUser.value && x.pass===examPass.value);
  if(u){examAuth.style.display='none'; examForm.style.display='block'; examMsg.innerText='';} else {examMsg.innerText='Invalid login';}
}
function showExamCreate(){alert('Feature not implemented yet');}
function showExamForgot(){alert('Feature not implemented yet');}

function calculateGrade(total){
  if(total>=70) return 'A';
  else if(total>=60) return 'B';
  else if(total>=50) return 'C';
  else if(total>=40) return 'D';
  else return 'F';
}
function calculateAllGrades(){
  for(let i=1;i<=4;i++){
    const cat1=Number(document.getElementById('unit'+i+'Cat1').value);
    const cat2=Number(document.getElementById('unit'+i+'Cat2').value);
    const exam=Number(document.getElementById('unit'+i+'Exam').value);
    const total=cat1+cat2+exam;
    document.getElementById('resUnit'+i).innerText=document.getElementById('unit'+i+'Name').value||'-';
    document.getElementById('resCat'+i+'1').innerText=cat1;
    document.getElementById('resCat'+i+'2').innerText=cat2;
    document.getElementById('resExam'+i).innerText=exam;
    document.getElementById('resTotal'+i).innerText=total;
    document.getElementById('resGrade'+i).innerText=calculateGrade(total);
  }
}
function downloadExamPDF(){
  const doc=new jsPDF();
  doc.text("Exam Results",14,20);
  const body=[];
  for(let i=1;i<=4;i++){
    body.push([document.getElementById('resUnit'+i).innerText,
               document.getElementById('resCat'+i+'1').innerText,
               document.getElementById('resCat'+i+'2').innerText,
               document.getElementById('resExam'+i).innerText,
               document.getElementById('resTotal'+i).innerText,
               document.getElementById('resGrade'+i).innerText]);
  }
  doc.autoTable({head:[['Unit','CAT1','CAT2','Exam','Total','Grade']],body});
  doc.save('Exam_Results.pdf');
}
</script>

</body>
</html>
