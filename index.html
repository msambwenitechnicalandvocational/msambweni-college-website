package com.msambweni.portal;

import com.google.auth.oauth2.GoogleCredentials;
import com.google.cloud.firestore.*;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import com.google.firebase.cloud.FirestoreClient;
import com.lowagie.text.*;
import com.lowagie.text.pdf.PdfWriter;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.core.io.InputStreamResource;
import org.springframework.http.*;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.io.*;
import java.util.Map;
import java.util.concurrent.ExecutionException;

@SpringBootApplication
@Controller
public class MsambweniPortalApplication {

    private Firestore db;

    public static void main(String[] args) {
        SpringApplication.run(MsambweniPortalApplication.class, args);
    }

    // ===== INIT FIRESTORE =====
    public void initFirestore() throws IOException {
        if (db != null) return;
        FileInputStream serviceAccount = new FileInputStream("serviceAccountKey.json");
        FirebaseOptions options = FirebaseOptions.builder()
                .setCredentials(GoogleCredentials.fromStream(serviceAccount))
                .build();
        if (FirebaseApp.getApps().isEmpty()) FirebaseApp.initializeApp(options);
        db = FirestoreClient.getFirestore();
    }

    // ===== HOME =====
    @GetMapping("/")
    public String home() {
        return "<html><body><h1>MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE</h1>"
                + "<a href='/login'>Login</a> | <a href='/dashboard'>Dashboard</a></body></html>";
    }

    // ===== LOGIN PAGE =====
    @GetMapping("/login")
    public String loginPage() {
        return "<html><body><h2>Login</h2>"
                + "<form method='post' action='/dashboard'>"
                + "Email: <input type='email' name='email'><br>"
                + "Password: <input type='password' name='password'><br>"
                + "<button type='submit'>Login</button>"
                + "</form></body></html>";
    }

    // ===== DASHBOARD =====
    @PostMapping("/dashboard")
    @ResponseBody
    public String dashboard() throws IOException, ExecutionException, InterruptedException {
        initFirestore();

        ApiFuture<QuerySnapshot> studentsSnap = db.collection("students").get();
        ApiFuture<QuerySnapshot> staffSnap = db.collection("staff").get();
        ApiFuture<QuerySnapshot> financeSnap = db.collection("finance").get();

        int totalStudents = studentsSnap.get().size();
        int totalStaff = staffSnap.get().size();

        double totalPaid = 0, totalBalance = 0;
        for (DocumentSnapshot d : financeSnap.get().getDocuments()) {
            double paid = d.getDouble("paid") != null ? d.getDouble("paid") : 0;
            totalPaid += paid;
            totalBalance += 40000 - paid;
        }

        return "<html><body><h1>Dashboard</h1>"
                + "<p>Total Students: " + totalStudents + "</p>"
                + "<p>Total Staff: " + totalStaff + "</p>"
                + "<p>Total Fees Paid: " + totalPaid + "</p>"
                + "<p>Total Balance: " + totalBalance + "</p>"
                + "<h3>Register Student</h3>"
                + "<form method='post' action='/student'>"
                + "Name: <input name='name'><br>Reg No: <input name='reg'><br>Email: <input name='email'><br>"
                + "Course: <input name='course'><br>Term: <input name='term'><br>Year: <input name='year'><br>"
                + "<button type='submit'>Save & Download PDF</button>"
                + "</form></body></html>";
    }

    // ===== SAVE STUDENT + PDF =====
    @PostMapping("/student")
    public ResponseEntity<InputStreamResource> saveStudent(@RequestParam Map<String, String> params) throws Exception {
        initFirestore();

        String reg = params.get("reg");
        db.collection("students").document(reg).set(params);

        // PDF
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        Document doc = new Document();
        PdfWriter.getInstance(doc, out);
        doc.open();
        doc.add(new Paragraph("STUDENT RECORD"));
        for (Map.Entry<String, String> e : params.entrySet()) {
            doc.add(new Paragraph(e.getKey() + ": " + e.getValue()));
        }
        doc.close();

        InputStreamResource resource = new InputStreamResource(new ByteArrayInputStream(out.toByteArray()));
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment;filename=Student_" + reg + ".pdf")
                .contentType(MediaType.APPLICATION_PDF)
                .contentLength(out.size())
                .body(resource);
    }
}
