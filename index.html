<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Msambweni TVC Portal</title>

<script type="module">
  /* ================= FIREBASE IMPORTS ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  /* ================= FIREBASE CONFIG ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyAhiabnqiPW1Y_USf7r_UW2KymUyfiYmVs",
    authDomain: "studentregistration-b3f93.firebaseapp.com",
    projectId: "studentregistration-b3f93",
    storageBucket: "studentregistration-b3f93.firebasestorage.app",
    messagingSenderId: "429282074438",
    appId: "1:429282074438:web:d50150839003b34a3ecf47"
  };

  /* ================= INITIALIZE ================= */
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /* üîë EXPOSE TO WINDOW (CRITICAL FIX) */
  window.db = db;
  window.auth = auth;
  window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.sendPasswordResetEmail = sendPasswordResetEmail;
  window.signOut = signOut;
  window.addDoc = addDoc;
  window.collection = collection;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
  window.serverTimestamp = serverTimestamp;
</script>

<style>
body{font-family:Segoe UI;background:#f5f5f5}
.card{background:#fff;padding:20px;max-width:400px;margin:50px auto;border-radius:10px}
button{padding:10px;width:100%;margin-top:10px}
</style>
</head>

<body>

<div class="card">
  <h2>Portal Login</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <select id="role">
    <option value="">Select Role</option>
    <option value="student">Student</option>
    <option value="admin">Admin</option>
    <option value="finance">Finance Officer</option>
    <option value="exam">Exam Officer</option>
  </select>

  <button onclick="loginUser()">Login</button>
  <button onclick="signupUser()">Create Account</button>
  <button onclick="resetPassword()">Forgot Password</button>

  <p id="status"></p>
</div>

<script>
/* ================= AUTH FUNCTIONS ================= */

async function signupUser(){
  const email = email.value;
  const password = document.getElementById("password").value;
  const role = document.getElementById("role").value;
  status.innerText = "‚è≥ Creating account...";

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await addDoc(collection(db,"users"),{
      uid: cred.user.uid,
      email,
      role,
      createdAt: serverTimestamp()
    });
    status.innerText = "‚úÖ Account created successfully";
  }catch(e){
    status.innerText = "‚ùå " + e.message;
  }
}

async function loginUser(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const role = document.getElementById("role").value;
  status.innerText = "‚è≥ Logging in...";

  try{
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const q = query(collection(db,"users"), where("uid","==",cred.user.uid));
    const snap = await getDocs(q);

    if(snap.empty){ throw "No role assigned"; }

    const userRole = snap.docs[0].data().role;
    if(userRole !== role){ throw "Role mismatch"; }

    status.innerText = `‚úÖ Logged in as ${role}`;
  }catch(e){
    status.innerText = "‚ùå " + e;
  }
}

async function resetPassword(){
  const email = document.getElementById("email").value;
  status.innerText = "‚è≥ Sending reset link...";
  try{
    await sendPasswordResetEmail(auth,email);
    status.innerText = "‚úÖ Reset link sent to email";
  }catch(e){
    status.innerText = "‚ùå " + e.message;
  }
}
</script>

</body>
</html>
