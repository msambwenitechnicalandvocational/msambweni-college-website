<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MTVC College System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI,sans-serif;background:#f0f2f5;}
header{height:60px;background:#0d47a1;color:#fff;display:flex;align-items:center;padding:0 20px;position:fixed;width:100%;top:0;z-index:3;justify-content:space-between;}
header img{height:40px;margin-right:10px;}
#loginBox{width:360px;margin:120px auto;background:#fff;padding:25px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.2);}
#loginBox h3{text-align:center;color:#0d47a1;}
input,select,button{width:100%;padding:12px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:14px;}
button{background:#0d47a1;color:#fff;font-weight:bold;cursor:pointer;transition:0.3s;}
button:hover{background:#093373;}

#portal{display:none;}
#sidebar{
  width:250px;background:#1a237e;color:#fff;position:fixed;top:60px;bottom:0;overflow-y:auto;transition:0.3s;
}
#sidebar.collapsed{width:60px;}
#sidebar a{display:flex;align-items:center;padding:14px 20px;color:#fff;text-decoration:none;transition:0.3s;cursor:pointer;}
#sidebar a:hover{background:#3949ab;}
#sidebar a.active{background:#0d47a1;font-weight:bold;}
#sidebar .icon{width:25px;display:inline-block;text-align:center;}
#sidebar .text{flex:1;white-space:nowrap;overflow:hidden;}
#sidebar.collapsed .text{display:none;}
#sidebar .submenu{display:none;padding-left:40px;}
#sidebar.collapsed .submenu{padding-left:0;position:absolute;background:#2c2c54;left:60px;top:auto;z-index:10;width:200px;}
#content{margin-left:250px;margin-top:60px;padding:20px;transition:0.3s;}
#sidebar.collapsed ~ #content{margin-left:60px;}

.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);margin-bottom:20px;}
.msg{font-weight:bold;color:green;margin-top:10px;}
.table{width:100%;border-collapse:collapse;margin-top:15px;}
.table th,.table td{border:1px solid #ccc;padding:8px;text-align:center;}
.table th{background:#0d47a1;color:#fff;}
.table tr:nth-child(even){background:#f2f2f2;}
.small-btn{padding:6px 12px;margin:4px;border-radius:6px;background:#0d47a1;color:#fff;border:none;cursor:pointer;transition:0.3s;}
.small-btn:hover{background:#093373;}
.dashboard-cards{display:flex;flex-wrap:wrap;gap:15px;margin-top:15px;}
.dashboard-card{flex:1 1 200px;background:#fff;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);position:relative;transition:0.3s;}
.dashboard-card h2{margin:10px 0;font-size:28px;}
.dashboard-card span{font-size:14px;color:#f0f0f0;}
.card-students{background:#1abc9c;}
.card-staff{background:#3498db;}
.card-fees{background:#e67e22;}
.card-balance{background:#e74c3c;}
.notification-item{border-bottom:1px solid #ccc;padding:6px 0;}
.toggle-btn{background:#0d47a1;color:#fff;border:none;padding:8px 12px;font-size:18px;cursor:pointer;border-radius:5px;}
@media(max-width:768px){
  #sidebar{width:100%;position:relative;height:auto;}
  #sidebar.collapsed{width:100%;}
  #content{margin-left:0;}
  .dashboard-cards{flex-direction:column;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h3>MTVC Secure Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <select id="role">
    <option value="">Select Role</option>
    <option value="student">Student</option>
    <option value="staff">Staff</option>
    <option value="finance">Finance</option>
    <option value="admin">Admin</option>
  </select>
  <button type="button" onclick="login()">Login</button>
  <button type="button" onclick="signup()">Create Account</button>
  <p id="loginMsg"></p>
</div>

<!-- PORTAL -->
<div id="portal">
<header>
  <div style="display:flex;align-items:center;">
    <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
    <img src="logo.png" alt="MTVC Logo">
    <h3 style="margin-left:10px;">MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE</h3>
  </div>
</header>

<div id="sidebar">
  <a onclick="menuClick('dashboard')"><span class="icon">üè†</span><span class="text">Dashboard</span></a>
  <a onclick="toggleSubmenu('studentSub')"><span class="icon">üéì</span><span class="text">Students ‚ñº</span></a>
  <div id="studentSub" class="submenu">
      <a onclick="menuClick('student')">Registration</a>
  </div>
  <a onclick="toggleSubmenu('academicsSub')"><span class="icon">üìò</span><span class="text">Academics ‚ñº</span></a>
  <div id="academicsSub" class="submenu">
      <a onclick="menuClick('academics')">Results</a>
      <a onclick="menuClick('notifications')">Notifications</a>
  </div>
  <a onclick="toggleSubmenu('financeSub')"><span class="icon">üí∞</span><span class="text">Finance ‚ñº</span></a>
  <div id="financeSub" class="submenu">
      <a onclick="menuClick('finance')">Fee Payment</a>
  </div>
  <a onclick="toggleSubmenu('staffSub')"><span class="icon">üë®‚Äçüè´</span><span class="text">Staff ‚ñº</span></a>
  <div id="staffSub" class="submenu">
      <a onclick="menuClick('staff')">Staff Details</a>
  </div>
  <a onclick="toggleSubmenu('adminSub')"><span class="icon">‚öô</span><span class="text">Admin ‚ñº</span></a>
  <div id="adminSub" class="submenu">
      <a onclick="menuClick('admin')">Settings</a>
  </div>
  <a onclick="logout()"><span class="icon">üö™</span><span class="text">Logout</span></a>
</div>

<div id="content">
  <!-- Dashboard -->
  <div class="card" id="dashboard">
    <h3>Dashboard</h3>
    <div class="dashboard-cards">
      <div class="dashboard-card card-students"><h2 id="totalStudents">0</h2><span>Total Students</span></div>
      <div class="dashboard-card card-staff"><h2 id="totalStaff">0</h2><span>Total Staff</span></div>
      <div class="dashboard-card card-fees"><h2 id="totalFees">0</h2><span>Total Fees Paid</span></div>
      <div class="dashboard-card card-balance"><h2 id="totalBalance">0</h2><span>Total Balance</span></div>
    </div>
  </div>

  <!-- STUDENT -->
  <form class="card" id="student" onsubmit="return false;">
    <h3>Student Registration</h3>
    <input id="stuName" placeholder="Name">
    <input id="stuReg" placeholder="Reg No">
    <input id="stuEmail" placeholder="Email">
    <input id="stuTerm" placeholder="Term (e.g., 1,2,3)">
    <input id="stuYear" placeholder="Year">
    <input id="stuCourse" placeholder="Course">
    <button type="button" onclick="saveStudent()">Save & Download PDF</button>
    <p class="msg" id="stuMsg"></p>
  </form>

  <!-- FINANCE -->
  <form class="card" id="finance" onsubmit="return false;">
    <h3>Finance</h3>
    <input id="fReg" placeholder="Reg No">
    <input id="fName" placeholder="Name">
    <input id="fPaid" type="number" placeholder="Amount Paid">
    <input id="fTerm" placeholder="Term">
    <input id="fYear" placeholder="Year">
    <button type="button" onclick="saveFinance()">Save & Download Fee PDF</button>
    <p class="msg" id="fMsg"></p>
    <div id="feeStatement"></div>
  </form>

  <!-- ACADEMICS -->
  <form class="card" id="academics" onsubmit="return false;">
    <h3>Academic Results</h3>
    <input id="aReg" placeholder="Reg No">
    <input id="aName" placeholder="Name">
    <input id="aUnit" placeholder="Unit">
    <input id="aScore" type="number" placeholder="Score">
    <input id="aTerm" placeholder="Term">
    <input id="aYear" placeholder="Year">
    <button type="button" onclick="saveResult()">Save & Download PDF</button>
    <p class="msg" id="aMsg"></p>
    <div id="transcript"></div>
  </form>

  <!-- NOTIFICATIONS -->
  <div class="card" id="notifications">
    <h3>Notifications</h3>
    <div id="notifyList"></div>
  </div>

  <!-- STAFF -->
  <form class="card" id="staff" onsubmit="return false;">
    <h3>Staff Details</h3>
    <input id="sName" placeholder="Name">
    <input id="sRole" placeholder="Role">
    <input id="sEmail" placeholder="Email">
    <input id="sPhone" placeholder="Phone">
    <input id="sDept" placeholder="Department">
    <button type="button" onclick="saveStaff()">Save & Download PDF</button>
    <p class="msg" id="sMsg"></p>
  </form>

  <!-- ADMIN -->
  <form class="card" id="admin" onsubmit="return false;">
    <h3>Admin Settings</h3>
    <input id="adName" placeholder="Setting">
    <button type="button" onclick="saveAdmin()">Save</button>
    <p class="msg" id="adMsg"></p>
  </form>
</div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyAhiabnqiPW1Y_USf7r_UW2KymUyfiYmVs",
 authDomain:"studentregistration-b3f93.firebaseapp.com",
 projectId:"studentregistration-b3f93",
 databaseURL:"https://studentregistration-b3f93-default-rtdb.firebaseio.com"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* ===== SIGNUP ===== */
async function signup(){
  if(!email.value||!password.value||!role.value){loginMsg.innerText="Fill all fields"; return;}
  loginMsg.style.color="blue"; loginMsg.innerText="Creating account...";
  try{
    const existing = await db.collection("users").where("email","==",email.value).get();
    if(existing.size>0){loginMsg.innerText=`Account with this email exists`; return;}
    const cred = await auth.createUserWithEmailAndPassword(email.value,password.value);
    await db.collection("users").doc(cred.user.uid).set({email:email.value, role:role.value});
    loginMsg.style.color="green"; loginMsg.innerText="‚úÖ Account created successfully!";
  }catch(e){loginMsg.style.color="red"; loginMsg.innerText=e.message;}
}

/* ===== LOGIN with ROLE BASED ACCESS ===== */
async function login(){
  loginMsg.style.color="blue"; loginMsg.innerText="Logging in...";
  try{
    const cred = await auth.signInWithEmailAndPassword(email.value,password.value);
    const doc = await db.collection("users").doc(cred.user.uid).get();
    if(!doc.exists){loginMsg.style.color="red"; loginMsg.innerText="User data not found"; return;}
    const userRole = doc.data().role || "unknown";

    loginBox.style.display="none";
    portal.style.display="block";
    loginMsg.style.color="green"; loginMsg.innerText="üéâ Logged in!";

    // Hide all sections first
    const allSections = document.querySelectorAll("#content > .card, #content > form");
    allSections.forEach(sec => sec.style.display = "none");

    // Hide all sidebar links first
    document.querySelectorAll("#sidebar a").forEach(link => link.style.display="none");

    // Dashboard always visible
    document.getElementById("dashboard").style.display = "block";
    document.querySelector("#sidebar a[onclick=\"menuClick('dashboard')\"]").style.display = "flex";

    if(userRole==="student"){
      document.getElementById("student").style.display="block";
      document.getElementById("academics").style.display="block";
      document.getElementById("notifications").style.display="block";
      document.querySelector("#sidebar a[onclick=\"toggleSubmenu('studentSub')\"]").style.display="flex";
      document.querySelector("#sidebar a[onclick=\"toggleSubmenu('academicsSub')\"]").style.display="flex";
    }
    if(userRole==="staff"){
      document.getElementById("staff").style.display="block";
      document.querySelector("#sidebar a[onclick=\"toggleSubmenu('staffSub')\"]").style.display="flex";
    }
    if(userRole==="finance"){
      document.getElementById("finance").style.display="block";
      document.querySelector("#sidebar a[onclick=\"toggleSubmenu('financeSub')\"]").style.display="flex";
    }
    if(userRole==="admin"){
      allSections.forEach(sec => sec.style.display="block");
      document.querySelectorAll("#sidebar a").forEach(link => link.style.display="flex");
    }

    updateDashboard();
    loadNotifications();

  }catch(e){loginMsg.style.color="red"; loginMsg.innerText=e.message;}
}

/* SIDEBAR TOGGLE */
function toggleSidebar(){document.getElementById("sidebar").classList.toggle("collapsed");}
function menuClick(id){document.querySelectorAll("#content > .card, #content > form").forEach(d=>d.style.display="none"); document.getElementById(id).style.display="block";}
function toggleSubmenu(id){const el=document.getElementById(id); el.style.display=el.style.display==='block'?'none':'block';}
function logout(){auth.signOut(); location.reload();}

/* ===== DASHBOARD, SAVE, PDF, NOTIFICATIONS functions remain same as previous code ===== */
</script>
</body>
</html>
