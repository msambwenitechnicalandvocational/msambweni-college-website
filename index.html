<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Msambweni TVC Portals</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --blue:#0d47a1;
  --light:#1976d2;
  --green:#2e7d32;
  --red:#c62828;
  --hover:#e3f2fd;
}
body{margin:0;font-family:Segoe UI,Arial;background:#f4f7fb;}
header{
  background:linear-gradient(90deg,var(--blue),var(--light));
  color:white;
  padding:15px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
}
header img{height:60px; margin:5px;}
header h1{margin:0;font-size:18px;text-align:center;flex:1;}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{background:white;border-radius:14px;padding:25px;box-shadow:0 15px 35px rgba(0,0,0,.2);margin-bottom:30px;}
h2,h3{text-align:center;color:var(--blue);}
input,select{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;}
button{padding:10px 18px;border:none;border-radius:6px;color:white;cursor:pointer;margin-top:8px;}
.login{background:var(--light);}
.create{background:var(--green);}
.download{background:var(--green);}
.logout{background:var(--red);}
.link{text-align:center;color:var(--light);cursor:pointer;margin-top:8px;font-size:14px;}
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:10px;text-align:center;}
th{background:var(--light);color:white;}
tbody tr:nth-child(even){background:#f0f4f8;}
tbody tr:hover{background:#dbe9fc;}
footer{background:#0d47a1;color:white;padding:20px;text-align:center;margin-top:40px}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  header{flex-direction:column; text-align:center;}
  header h1{margin:10px 0;}
  .card{padding:15px;}
  input, select, button{font-size:14px;}
  table th, table td{padding:6px;font-size:12px;}
  button{padding:8px 12px;}
}
</style>
</head>
<body>

<header>
<img src="images/logo-left.png">
<h1>MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE</h1>
<img src="images/logo-right.png">
</header>

<div class="container">

<!-- PORTAL SELECTION -->
<div class="card" id="portalSelect">
<h2>Select Portal</h2>
<button class="login" onclick="openAuth('ict')">ICT Portal</button>
<button class="login" onclick="openAuth('library')">Library Portal</button>
<button class="login" onclick="openAuth('exam')">Exam Portal</button>
<button class="login" onclick="openAuth('finance')">Finance Portal</button>
</div>

<!-- AUTH MODAL -->
<div class="card hidden" id="auth">
<h3 id="authTitle"></h3>
<input id="aUser" placeholder="Username">
<input id="aPass" type="password" placeholder="Password">
<button class="login" onclick="login()">Login</button>
<div class="link" onclick="showCreate()">Create Account</div>
<div class="link" onclick="showForgot()">Forgot Password?</div>
<p id="authMsg"></p>
</div>

<div class="card hidden" id="create">
<h3>Create Account</h3>
<input id="cUser" placeholder="Username">
<input id="cPass" type="password" placeholder="Password">
<button class="create" onclick="createAccount()">Create Account</button>
<div class="link" onclick="backAuth()">Back to Login</div>
</div>

<div class="card hidden" id="forgot">
<h3>Recover Password</h3>
<input id="fUser" placeholder="Username">
<button class="login" onclick="recover()">Recover</button>
<div class="link" onclick="backAuth()">Back to Login</div>
<p id="fMsg"></p>
</div>


  

<!-- ICT PORTAL -->
<div class="card hidden" id="ict">
  <h3>ICT Support Portal</h3>

  <!-- Filter & Search -->
  <div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px;">
    <select id="ictFilter" onchange="filterICTTickets()">
      <option value="all">All Statuses</option>
      <option value="Pending">Pending</option>
      <option value="Resolved">Resolved</option>
    </select>
    <input id="ictSearch" placeholder="Search by Device, Issue, or Name" onkeyup="filterICTTickets()" style="flex:1;">
  </div>

  <!-- Tickets Table -->
  <table id="ictTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Issue</th>
        <th>Device</th>
        <th>Start Date</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- New Ticket Form -->
  <input id="ictName" placeholder="Your Name">
  <input id="ictIssue" placeholder="Issue Description">
  <input type="date" id="ictStartDate" placeholder="Date Issue Started">
  <input id="ictDevice" placeholder="Device / Serial Number">
  <select id="ictStatus">
    <option>Pending</option>
    <option>Resolved</option>
  </select>
  <select id="ictPriority">
    <option>Low</option>
    <option>Medium</option>
    <option>High</option>
  </select>

  <button class="download" onclick="saveICTTicket()">Submit Ticket</button>
  <button class="download" onclick="downloadICTPDF()">Download All Tickets PDF</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<script>
// ===== ICT Portal Logic =====
if(!localStorage.getItem('ictTickets')) localStorage.setItem('ictTickets', JSON.stringify([]));

function saveICTTicket(){
  const tickets = JSON.parse(localStorage.getItem('ictTickets'));
  const ticket = {
    id: tickets.length + 1,
    name: document.getElementById('ictName').value,
    issue: document.getElementById('ictIssue').value,
    device: document.getElementById('ictDevice').value,
    status: document.getElementById('ictStatus').value,
    priority: document.getElementById('ictPriority').value,
    startDate: document.getElementById('ictStartDate').value,
    submittedDate: new Date().toLocaleString()
  };
  if(!ticket.name || !ticket.issue || !ticket.device || !ticket.startDate){
    alert("Please fill all fields!");
    return;
  }
  tickets.push(ticket);
  localStorage.setItem('ictTickets', JSON.stringify(tickets));
  document.getElementById('ictName').value='';
  document.getElementById('ictIssue').value='';
  document.getElementById('ictDevice').value='';
  document.getElementById('ictStartDate').value='';
  document.getElementById('ictStatus').value='Pending';
  document.getElementById('ictPriority').value='Low';
  loadICTTickets();
  alert("Ticket submitted successfully!");
}

function loadICTTickets(){
  const tickets = JSON.parse(localStorage.getItem('ictTickets'));
  const tbody = document.querySelector("#ictTable tbody");
  tbody.innerHTML='';
  tickets.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${t.name}</td>
      <td>${t.issue}</td>
      <td>${t.device}</td>
      <td>${t.startDate}</td>
      <td>${t.status}</td>
      <td>${t.priority}</td>
      <td>
        ${t.status==='Pending'?`<button onclick="resolveTicket(${t.id})" style="background:var(--green);padding:4px 8px;border-radius:4px;color:white;">Resolve</button>`:''}
      </td>
    `;
    tbody.appendChild(tr);
  });
  filterICTTickets();
}

function resolveTicket(id){
  const tickets = JSON.parse(localStorage.getItem('ictTickets'));
  const ticket = tickets.find(t=>t.id===id);
  ticket.status='Resolved';
  localStorage.setItem('ictTickets', JSON.stringify(tickets));
  loadICTTickets();
}

// Filter & Search
function filterICTTickets(){
  const filter = document.getElementById('ictFilter').value;
  const search = document.getElementById('ictSearch').value.toLowerCase();
  const rows = document.querySelectorAll("#ictTable tbody tr");
  rows.forEach(row=>{
    const status = row.cells[5].innerText;
    const name = row.cells[1].innerText.toLowerCase();
    const issue = row.cells[2].innerText.toLowerCase();
    const device = row.cells[3].innerText.toLowerCase();
    row.style.display = ((filter==='all' || filter===status) && 
                        (issue.includes(search) || device.includes(search) || name.includes(search))) ? '' : 'none';
  });
}

// Generate PDF
function downloadICTPDF(){
  const tickets = JSON.parse(localStorage.getItem('ictTickets'));
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.setTextColor(13,71,161);
  doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",105,20,{align:"center"});
  doc.setFontSize(12);
  doc.text("ICT SUPPORT TICKETS",105,30,{align:"center"});
  doc.text("Generated by: ICT Manager Samson",20,40);
  doc.text("Generated on: "+new Date().toLocaleString(),20,50);

  if(tickets.length===0){ doc.text("No tickets submitted.",20,60); }
  else{
    const body = tickets.map(t=>[t.id,t.name,t.issue,t.device,t.startDate,t.status,t.priority,t.submittedDate]);
    doc.autoTable({
      startY:60,
      head:[["ID","Name","Issue","Device","Start Date","Status","Priority","Submitted"]],
      body:body,
      theme:'grid',
      headStyles:{fillColor:[13,71,161],textColor:255},
      styles:{cellPadding:4,fontSize:10},
      alternateRowStyles:{fillColor:[230,230,250]}
    });
  }
  doc.save("ICT_Tickets.pdf");
}

// Load tickets when ICT portal opens
document.getElementById('ict').addEventListener('click',loadICTTickets);
</script>






<!-- LIBRARY PORTAL -->
<div class="card hidden" id="libraryAuth">
  <h3>Library Portal Login</h3>
  <input id="libUser" placeholder="Username">
  <input id="libPass" type="password" placeholder="Password">
  <button class="login" onclick="libraryLogin()">Login</button>
  <div class="link" onclick="showLibraryCreate()">Create Account</div>
  <div class="link" onclick="showLibraryForgot()">Forgot Password?</div>
  <p id="libAuthMsg"></p>
</div>

<div class="card hidden" id="libraryCreate">
  <h3>Create Library Account</h3>
  <input id="libCUser" placeholder="Username">
  <input id="libCPass" type="password" placeholder="Password">
  <button class="create" onclick="libraryCreateAccount()">Create Account</button>
  <div class="link" onclick="backLibraryAuth()">Back to Login</div>
</div>

<div class="card hidden" id="libraryForgot">
  <h3>Recover Library Password</h3>
  <input id="libFUser" placeholder="Username">
  <button class="login" onclick="libraryRecover()">Recover</button>
  <div class="link" onclick="backLibraryAuth()">Back to Login</div>
  <p id="libFMsg"></p>
</div>

<div class="card hidden" id="library">
  <h3>Library Portal</h3>

  <!-- Student Info -->
  <input id="libStudentName" placeholder="Student Name">
  <input id="libCourse" placeholder="Course">
  <input id="libRegNo" placeholder="Registration Number">

  <!-- Library Form Table -->
  <table id="libTable">
    <thead>
      <tr>
        <th>Book</th>
        <th>Author</th>
        <th>Action</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Form Fields -->
  <input id="libTitle" placeholder="Book Title">
  <input id="libAuthor" placeholder="Author">
  <select id="libAction">
    <option>Borrow</option>
    <option>Return</option>
  </select>
  <input type="file" id="libFile" accept="application/pdf">
  <button class="download" onclick="saveLibraryEntry()">Save Entry</button>

  <!-- Attendance -->
  <h4>Attendance</h4>
  <label><input type="checkbox" id="libAttendance"> Mark Present</label>

  <!-- PDF Download -->
  <button class="download" onclick="downloadLibraryPDF()">Download PDF</button>
  <button class="logout" onclick="logoutLibrary()">Logout</button>
</div>

<script>
if(!localStorage.getItem('libraryUsers')) localStorage.setItem('libraryUsers', JSON.stringify({}));
if(!localStorage.getItem('libraryEntries')) localStorage.setItem('libraryEntries', JSON.stringify([]));
if(!localStorage.getItem('libraryAttendance')) localStorage.setItem('libraryAttendance', JSON.stringify({}));

// ==== Authentication Functions ====
function libraryLogin(){
  const users = JSON.parse(localStorage.getItem('libraryUsers'));
  const user = libUser.value, pass = libPass.value;
  if(users[user] && users[user].pass===pass){
    document.getElementById('libraryAuth').classList.add('hidden');
    document.getElementById('library').classList.remove('hidden');
    alert("Welcome to the Library Portal!");
  } else {
    libAuthMsg.innerText="Invalid username or password";
  }
}

function showLibraryCreate(){ document.getElementById('libraryAuth').classList.add('hidden'); document.getElementById('libraryCreate').classList.remove('hidden'); }
function showLibraryForgot(){ document.getElementById('libraryAuth').classList.add('hidden'); document.getElementById('libraryForgot').classList.remove('hidden'); }
function backLibraryAuth(){ document.getElementById('libraryCreate').classList.add('hidden'); document.getElementById('libraryForgot').classList.add('hidden'); document.getElementById('libraryAuth').classList.remove('hidden'); }

function libraryCreateAccount(){
  const users = JSON.parse(localStorage.getItem('libraryUsers'));
  const user = libCUser.value, pass = libCPass.value;
  if(users[user]){ alert("Username exists"); return; }
  users[user]={pass:pass};
  localStorage.setItem('libraryUsers', JSON.stringify(users));
  alert("Account created successfully!");
  backLibraryAuth();
}

function libraryRecover(){
  const users = JSON.parse(localStorage.getItem('libraryUsers'));
  const user = libFUser.value;
  libFMsg.innerText = users[user] ? "Password: "+users[user].pass : "User not found";
}

// ==== Library Portal Functions ====
function saveLibraryEntry(){
  const entries = JSON.parse(localStorage.getItem('libraryEntries'));
  const name = libStudentName.value, course=libCourse.value, regNo=libRegNo.value;
  const book = libTitle.value, author=libAuthor.value, action=libAction.value;
  const fileName = libFile.files[0]? libFile.files[0].name : "No File";

  if(!name || !course || !regNo || !book || !author){ alert("Fill all fields"); return; }

  entries.push({student:name, course:course, regNo:regNo, book:book, author:author, action:action, file:fileName, date:new Date().toLocaleDateString()});
  localStorage.setItem('libraryEntries', JSON.stringify(entries));

  // Attendance
  const attendance = JSON.parse(localStorage.getItem('libraryAttendance'));
  attendance[regNo]=libAttendance.checked?"Present":"Absent";
  localStorage.setItem('libraryAttendance', JSON.stringify(attendance));

  libTitle.value=''; libAuthor.value=''; libAction.value='Borrow'; libFile.value=''; libAttendance.checked=false;
  loadLibraryTable();
  alert("Entry saved successfully!");
}

function loadLibraryTable(){
  const entries = JSON.parse(localStorage.getItem('libraryEntries'));
  const tbody = document.querySelector("#libTable tbody");
  tbody.innerHTML='';
  entries.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.book}</td><td>${e.author}</td><td>${e.action}</td><td>${e.date}</td>`;
    tbody.appendChild(tr);
  });
}

function downloadLibraryPDF(){
  const entries = JSON.parse(localStorage.getItem('libraryEntries'));
  const attendance = JSON.parse(localStorage.getItem('libraryAttendance'));
  const doc = new jsPDF();
  doc.setFontSize(14); doc.setTextColor(13,71,161);
  doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",105,20,{align:"center"});
  doc.setFontSize(12);
  doc.text("LIBRARY PORTAL REPORT",105,30,{align:"center"});
  doc.text("Generated by: ICT Manager Samson",20,40);
  doc.text("Generated on: "+new Date().toLocaleString(),20,50);

  if(entries.length>0){
    const body = entries.map(e=>[e.student,e.course,e.regNo,e.book,e.author,e.action,e.file,e.date,attendance[e.regNo]||"Absent"]);
    doc.autoTable({
      startY:60,
      head:[["Student Name","Course","Reg No","Book","Author","Action","File","Date","Attendance"]],
      body:body,
      theme:'grid',
      headStyles:{fillColor:[13,71,161],textColor:255},
      styles:{cellPadding:4,fontSize:10},
      alternateRowStyles:{fillColor:[245,245,255]}
    });
  } else {
    doc.text("No entries yet.",20,60);
  }
  doc.save("Library_Report.pdf");
}

function logoutLibrary(){
  document.getElementById('library').classList.add('hidden');
  document.getElementById('libraryAuth').classList.remove('hidden');
}

document.getElementById('library').addEventListener('click',loadLibraryTable);
</script>

<style>
#library input,#library select,#library button{margin-bottom:8px;}
#library h4{margin-top:15px;color:var(--blue);}
#library table{border-radius:10px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.15);}
#library th, #library td{border:1px solid #ccc; padding:8px; font-size:13px;}
#library th{background:var(--light); color:white;}
#library button.download{background:var(--green); padding:8px 15px; font-weight:600;}
#library button.logout{background:var(--red);}
</style>

  

// Prepare table data
let body=[];
for(let i=1;i<=4;i++){
  body.push([
    document.getElementById(`resUnit${i}`).innerText,
    document.getElementById(`resCat${i}1`).innerText,
    document.getElementById(`resCat${i}2`).innerText,
    document.getElementById(`resExam${i}`).innerText,
    document.getElementById(`resTotal${i}`).innerText,
    document.getElementById(`resGrade${i}`).innerText
  ]);
}

// Generate table in PDF
doc.autoTable({
  startY: y+10,               // Start position after student info
  head:[["Unit","CAT 1","CAT 2","Exam","Total","Grade"]],
  body: body,
  theme:'grid',                // Modern grid style
  headStyles:{fillColor:[13,71,161],textColor:255},
  styles:{cellPadding:4,fontSize:10},
  alternateRowStyles:{fillColor:[245,245,255]} // Stripe effect
});


  


  

<!-- FINANCE PORTAL -->
<div class="card hidden" id="finance">
<h3>Finance Portal</h3>
<table id="fHistory">
<thead><tr><th>Date</th><th>Receipt</th><th>Amount</th></tr></thead>
<tbody>
<tr><td>10/01/2026</td><td>RC001</td><td>10,000</td></tr>
<tr><td>05/02/2026</td><td>RC002</td><td>10,000</td></tr>
</tbody>
</table>
<input id="fName" placeholder="Student Name">
<input id="fReg" placeholder="Registration Number">
<input id="fTotal" placeholder="Total Fees" value="50000">
<input id="fPaid" placeholder="Amount Paid" value="20000">
<p>Balance: <span id="fBalance">30000</span></p>
<button class="download" onclick="calcBalance()">Calculate Balance</button>
<button class="download" onclick="downloadFeePDF()">Download Fee Statement PDF</button>
<button class="logout" onclick="logout()">Logout</button>
</div>

</div>

<footer style="background:#0d47a1; color:white; padding:30px 20px; font-family:Segoe UI, Arial, sans-serif;">
  <div style="max-width:1100px; margin:auto; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center;">

    <!-- College Info -->
    <div style="flex:1; min-width:220px; margin-bottom:15px;">
      <h3 style="margin:0 0 5px 0; font-size:18px;">Msambweni Technical & Vocational College</h3>
      <p style="margin:0; font-size:14px;">Prepared by ICT Department | All Rights Reserved Â© 2026</p>
    </div>

    <!-- Quick Links -->
    <div style="flex:1; min-width:220px; text-align:center; margin-bottom:15px;">
      <h4 style="margin-bottom:8px;">Quick Links</h4>
      <a href="https://www.youtube.com" target="_blank" style="margin:0 5px; color:white; text-decoration:none; font-size:14px;">YouTube</a> |
      <a href="https://www.knec.ac.ke" target="_blank" style="margin:0 5px; color:white; text-decoration:none; font-size:14px;">KNEC</a> |
      <a href="https://www.kuccps.net" target="_blank" style="margin:0 5px; color:white; text-decoration:none; font-size:14px;">KUCCPS</a> |
      <a href="https://www.helb.co.ke" target="_blank" style="margin:0 5px; color:white; text-decoration:none; font-size:14px;">HELB</a> |
      <a href="https://kstvettlibrary.ac.ke" target="_blank" style="margin:0 5px; color:white; text-decoration:none; font-size:14px;">KSTVET Library</a>
    </div>

    <!-- Social Icons -->
    <div style="flex:1; min-width:220px; text-align:right; margin-bottom:15px;">
      <p style="margin-bottom:8px;">Follow Us:</p>
      <a href="https://facebook.com" target="_blank" style="margin:0 6px; color:white; font-size:20px; text-decoration:none;">
        <i class="fab fa-facebook-square"></i>
      </a>
      <a href="https://twitter.com" target="_blank" style="margin:0 6px; color:white; font-size:20px; text-decoration:none;">
        <i class="fab fa-twitter-square"></i>
      </a>
      <a href="https://linkedin.com" target="_blank" style="margin:0 6px; color:white; font-size:20px; text-decoration:none;">
        <i class="fab fa-linkedin"></i>
      </a>
    </div>

  </div>
</footer>

<!-- Font Awesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>


<script>
const { jsPDF } = window.jspdf;

let portal='';
let users=JSON.parse(localStorage.getItem('portalUsers')||'{}');
let submissions=JSON.parse(localStorage.getItem('portalSubmissions')||'{}');

function openAuth(p){
  portal=p;
  portalSelect.classList.add("hidden");
  auth.classList.remove("hidden");
  authTitle.innerText=p.toUpperCase()+" PORTAL LOGIN";
  aUser.value=''; aPass.value=''; authMsg.innerText='';
}

function login(){
  if(!users[portal]){ authMsg.innerText="No account exists"; return; }
  const matched = users[portal].find(u=>u.user===aUser.value && u.pass===aPass.value);
  if(matched){
    auth.classList.add("hidden");
    document.getElementById(portal).classList.remove("hidden");
    loadPortalTable(portal);
  }else authMsg.innerText="Invalid login";
}

function createAccount(){
  if(!users[portal]) users[portal]=[];
  users[portal].push({user:cUser.value, pass:cPass.value});
  localStorage.setItem('portalUsers',JSON.stringify(users));
  alert("Account created for "+portal.toUpperCase());
  backAuth();
}

function recover(){
  if(!users[portal]){ fMsg.innerText="No account"; return;}
  const u = users[portal].find(x=>x.user===fUser.value);
  fMsg.innerText=u?("Password: "+u.pass):"User not found";
}

function showCreate(){ auth.classList.add("hidden"); create.classList.remove("hidden"); }
function showForgot(){ auth.classList.add("hidden"); forgot.classList.remove("hidden"); }
function backAuth(){ create.classList.add("hidden"); forgot.classList.add("hidden"); auth.classList.remove("hidden"); }

function logout(){
  document.querySelectorAll('.card').forEach(c=>c.classList.add("hidden"));
  portalSelect.classList.remove("hidden");
}

function savePortalData(p){
  if(!submissions[p]) submissions[p]=[];
  let rowData={};
  if(p==='ict'){
    rowData={Issue:ictIssue.value,Device:ictDevice.value,Status:ictStatus.value};
    ictIssue.value=''; ictDevice.value=''; ictStatus.value='Pending';
  }
  if(p==='library'){
    rowData={Book:libTitle.value,Author:libAuthor.value,Action:libAction.value};
    libTitle.value=''; libAuthor.value=''; libAction.value='Borrow';
  }
  if(p==='exam'){
    rowData={Unit:examUnit.value,Type:examType.value};
    examUnit.value=''; examType.value='Special Exam';
  }
  if(p==='finance'){
    rowData={Date:new Date().toLocaleDateString(),Receipt:'RC'+(submissions[p].length+1).toString().padStart(3,'0'),Amount:Number(fPaid.value)};
    const tbody=document.querySelector("#fHistory tbody");
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${rowData.Date}</td><td>${rowData.Receipt}</td><td>${rowData.Amount.toLocaleString()}</td>`;
    tbody.appendChild(tr);
    calcBalance();
  }
  if(p!=='finance') submissions[p].push(rowData);
  localStorage.setItem('portalSubmissions',JSON.stringify(submissions));
  if(p!=='finance') loadPortalTable(p);
  alert("Entry saved successfully!");
}

function loadPortalTable(p){
  if(p==='ict'){
    const tbody=document.querySelector("#ictTable tbody");
    tbody.innerHTML='';
    (submissions[p]||[]).forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.Issue}</td><td>${d.Device}</td><td>${d.Status}</td>`;
      tbody.appendChild(tr);
    });
  }
  if(p==='library'){
    const tbody=document.querySelector("#libTable tbody");
    tbody.innerHTML='';
    (submissions[p]||[]).forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.Book}</td><td>${d.Author}</td><td>${d.Action}</td>`;
      tbody.appendChild(tr);
    });
  }
  if(p==='exam'){
    const tbody=document.querySelector("#examTable tbody");
    tbody.innerHTML='';
    (submissions[p]||[]).forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.Unit}</td><td>${d.Type}</td>`;
      tbody.appendChild(tr);
    });
  }
}

function downloadPortalPDF(p){
  const doc=new jsPDF();
  doc.setFontSize(14); doc.setTextColor(13,71,161);
  doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",105,20,{align:"center"});
  doc.setFontSize(12);
  doc.text(p.toUpperCase()+" PORTAL SUBMISSIONS",105,30,{align:"center"});
  doc.text("Generated on: "+new Date().toLocaleString(),20,45);

  let data=submissions[p]||[];
  if(data.length===0){ doc.text("No submissions yet.",20,60); }
  else{
    const keys=Object.keys(data[0]);
    const body=data.map(d=>keys.map(k=>d[k]));
    doc.autoTable({
      startY:60, head:[keys], body:body, theme:'grid',
      headStyles:{fillColor:[13,71,161],textColor:255},
      styles:{cellPadding:4,fontSize:10},
      alternateRowStyles:{fillColor:[230,230,250]}
    });
  }
  doc.save(p+"_submissions.pdf");
}

function calcBalance(){
  let total=Number(fTotal.value);
  let paid=Number(fPaid.value);
  fBalance.innerText=(total-paid).toLocaleString();
}

function downloadFeePDF(){
  const doc=new jsPDF();
  doc.setFontSize(14); doc.setTextColor(13,71,161);
  doc.text("MSAMBWENI TECHNICAL & VOCATIONAL COLLEGE",105,20,{align:"center"});
  doc.setFontSize(12); doc.text("FEE STATEMENT",105,30,{align:"center"});
  doc.text("Generated on: "+new Date().toLocaleString(),20,45);
  doc.text("Student Name: "+fName.value,20,55);
  doc.text("Registration No: "+fReg.value,20,63);

  doc.autoTable({
    startY:75,
    head:[["Total Fees","Paid","Balance"]],
    body:[[fTotal.value,fPaid.value,fBalance.innerText]],
    theme:'grid', headStyles:{fillColor:[13,71,161],textColor:255},
    styles:{cellPadding:4,fontSize:10}, alternateRowStyles:{fillColor:[230,230,250]}
  });

  let payData=[];
  const rows=document.querySelectorAll("#fHistory tbody tr");
  for(let i=0;i<rows.length;i++){
    const cols=rows[i].querySelectorAll("td");
    payData.push([cols[0].innerText,cols[1].innerText,cols[2].innerText]);
  }

  doc.autoTable({
    startY:doc.lastAutoTable.finalY+10,
    head:[["Date","Receipt","Amount"]],
    body:payData,
    theme:'grid', headStyles:{fillColor:[13,71,161],textColor:255},
    styles:{cellPadding:4,fontSize:10}, alternateRowStyles:{fillColor:[245,245,255]}
  });

  doc.text("Prepared by: Accounts Office",20,doc.lastAutoTable.finalY+15);
  doc.save("Fee_Statement.pdf");
}
</script>
</body>
</html>



